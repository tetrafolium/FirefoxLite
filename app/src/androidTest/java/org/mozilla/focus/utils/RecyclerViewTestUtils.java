/* -*- Mode: Java; c-basic-offset: 4; tab-width: 20; indent-tabs-mode: nil; -*-
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

package org.mozilla.focus.utils;

import androidx.annotation.IdRes;
import androidx.annotation.NonNull;
import androidx.test.espresso.UiController;
import androidx.test.espresso.ViewAction;
import androidx.test.espresso.matcher.BoundedMatcher;
import androidx.recyclerview.widget.RecyclerView;
import android.view.View;

import org.hamcrest.Description;
import org.hamcrest.Matcher;
import org.hamcrest.TypeSafeMatcher;

import static androidx.test.espresso.Espresso.onView;
import static androidx.test.espresso.assertion.ViewAssertions.matches;
import static androidx.test.espresso.matcher.ViewMatchers.isDisplayed;
import static androidx.test.espresso.matcher.ViewMatchers.withId;
import static androidx.test.internal.util.Checks.checkNotNull;
import static org.hamcrest.core.AllOf.allOf;

public final class RecyclerViewTestUtils {

public static Matcher<View> atPosition(final int position, @NonNull final Matcher<View> itemMatcher) {
	checkNotNull(itemMatcher);
	return new BoundedMatcher<View, RecyclerView>(RecyclerView.class) {
		       @Override
		       public void describeTo(Description description) {
			       description.appendText("has item at position " + position + ": ");
			       itemMatcher.describeTo(description);
		       }

		       @Override
		       protected boolean matchesSafely(final RecyclerView view) {
			       final RecyclerView.ViewHolder viewHolder = view.findViewHolderForAdapterPosition(position);
			       if (viewHolder == null) {
				       // has no item on such position
				       return false;
			       }
			       return itemMatcher.matches(viewHolder.itemView);
		       }
	};
}

public static ViewAction clickChildViewWithId(final int id) {
	return new ViewAction() {
		       @Override
		       public Matcher<View> getConstraints() {
			       return null;
		       }

		       @Override
		       public String getDescription() {
			       return "Click on a child view with specified id.";
		       }

		       @Override
		       public void perform(UiController uiController, View view) {
			       View v = view.findViewById(id);
			       v.performClick();
		       }
	};
}

public static int getCountFromRecyclerView(@IdRes int recyclerViewId) {
	final int[] COUNT = {0};
	Matcher matcher = new TypeSafeMatcher<View>() {
		@Override
		protected boolean matchesSafely(View item) {
			COUNT[0] = ((RecyclerView) item).getAdapter().getItemCount();
			return true;
		}
		@Override
		public void describeTo(Description description) {
		}
	};
	onView(allOf(withId(recyclerViewId), isDisplayed())).check(matches(matcher));
	return COUNT[0];
}

}
